---
title: "Honors Thesis - NICU Data Analysis"
author: "Emilee Lewis"
date: "1/7/2026"
output:
  html_document:
    highlight: tango
    theme: flatly
---


```{r knitr, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r load-packages, warning = FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(GGally)
library(tidymodels)
library(caret)
library(broom)
library(rpart)
library(rpart.plot)
library(ranger)
```


```{r load-data}
duke_nicu <- read_xlsx("Data/Duke NICU Data.xlsx")
```


## Data Dictionary

| Variable                      | Description
|:----------------|:-----------------------------------------------------------------
|`patient_id`                   | De-identified, randomized patient identification number assigned to each infant
|`survival_status`              | Whether the infant was alive or deceased at the time of discharge
|`gestational_age`              | Gestational age at birth (in weeks)
|`birth_weight`                 | Birth weight of the infant (in grams)
|`gender`                       | Sex of the infant
|`inborn`                       | Whether the infant was born at Duke Hospital or transferred from another facility (`Yes`, `No`)
|`race_ethnicity`               | Racial/ethnic classification of the infant (`White`, `Black`, `Other`)
|`length_of_stay`               | Total length of stay (in days) from admission to discharge or death
|`ivh`                          | Presence or grade of intraventricular hemorrhage (IVH), bleeding into the internal structures of the brain (`None`, `Grade I`, `Grade II`, `Grade III`, `Grade IV`)
|`rop`                          | Presence or stage of retinopathy of prematurity (ROP), a condition affecting blood vessels in the eye that leads to blindness if not promptly treated (`None`, `Stage I`, `Stage II`, `Stage III–IV (No Cryo or Laser Surgery)`, `Stage III–IV (With Cryo or Laser Surgery)`)
|`nec`                          | Presence or type of necrotizing enterocolitis (NEC), a severe neonatal intestinal condition (`None`, `Medical`, `Surgical`)
|`pda`                          | Presence and management of patent ductus arteriosus (PDA), a neonatal cardiovascular anomaly requiring medical or surgical intervention (`None`, `None (Medication Only)`, `Yes (Medically Treated)`, `Yes (Ligated)`, `Yes (Untreated)`)


## Data Cleaning

```{r duke_nicu_clean}
duke_nicu_clean <- duke_nicu %>%
  select(-"BWgt", -"ROP", -"PDA", -"LOS Predictor") %>%
  clean_names() %>%
  rename(patient_id = pt_id_rnd_num,
         survival_status = alive_died,
         gestational_age = gest_age,
         length_of_stay = los,
         rop = rop_abbrev,
         pda = pda_condensed_rx) %>%
  mutate(gender = recode(gender,
                         "M" = "Male",
                         "F" = "Female"),
         inborn = recode(inborn,
                         "YES" = "Yes",
                         "NO" = "No"),
         race_ethnicity = recode(race_ethnicity,
                                 "OTHER" = "Other",
                                 "WHITE" = "White",
                                 "BLACK" = "Black"),
         ivh = recode(ivh,
                      "NONE" = "None",
                      "GRADE I" = "Grade I",
                      "GRADE II" = "Grade II",
                      "GRADE III" = "Grade III",
                      "GRADE IV" = "Grade IV"),
         rop = recode(rop,
                      "NONE" = "None",
                      "STAGE I" = "Stage I",
                      "STAGE II" = "Stage II",
                      "STAGE III-IV WITH CRYO OR LASER SURGERY" = "Stage III–IV (With Cryo or Laser Surgery)",
                      "STAGE III-IV, NO CRYO OR LASER SURGERY" = "Stage III–IV (No Cryo or Laser Surgery)"),
         nec = recode(nec,
                      "NONE" = "None",
                      "MEDICAL" = "Medical",
                      "SURGICAL" = "Surgical"),
         pda = recode(pda,
                      "NONE" = "None",
                      "NONE-RX" = "None (Medication Only)",
                      "YES, LIGATED" = "Yes (Ligated)",
                      "YES-RX" = "Yes (Medically Treated)",
                      "YES, NO TX" = "Yes (Untreated)"),
         ivh = fct_explicit_na(ivh, na_level = "Missing"),
         nec = fct_explicit_na(nec, na_level = "Missing"),
         pda = fct_explicit_na(pda, na_level = "Missing"),
         across(c(gender, inborn, race_ethnicity, survival_status,
                  ivh, rop, nec, pda), ~ as.factor(.)))
```

```{r duke_nicu_clean-colSums}
colSums(is.na(duke_nicu_clean))
```

```{r duke_nicu_clean-summary}
summary(duke_nicu_clean$gestational_age)
summary(duke_nicu_clean$birth_weight)
summary(duke_nicu_clean$length_of_stay)
```


## Exploratory Data Analysis

```{r duke_nicu_clean-hist, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = length_of_stay)) +
  geom_histogram(bins = 30, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = "Number of Infants",
       title = "Distribution of Length of Stay")
```

```{r duke_nicu_clean-hist2, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = log(length_of_stay + 1))) +
  geom_histogram(bins = 20, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "log(LOS + 1)",
       y = "Number of Infants",
       title = "Log-Transformed Distribution of Length of Stay")
```

```{r duke_nicu_clean-bar}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = survival_status,
                     fill = survival_status)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Number of Infants",
       title = "Distribution of Survival Status")
```

```{r duke_nicu_clean-col}
duke_nicu_clean %>%
  group_by(survival_status) %>%
  summarize(mean_los = mean(length_of_stay, na.rm = TRUE)) %>%
  ggplot(mapping = aes(x = survival_status,
                       y = mean_los,
                       fill = survival_status)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Average Length of Stay (Days)",
       title = "Average Length of Stay by Survival Status")
```

```{r duke_nicu_clean-hist3}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = gestational_age)) +
  geom_histogram(bins = 20, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Gestational Age (Weeks)",
       y = "Number of Infants",
       title = "Distribution of Gestational Age")
```

```{r duke_nicu_clean-line}
duke_nicu_clean %>%
  group_by(gestational_age) %>%
  summarize(mean_los = mean(length_of_stay, na.rm = TRUE)) %>%
  ggplot(mapping = aes(x = gestational_age,
                       y = mean_los)) +
  geom_line(color = "#4E79A7") +
  geom_point() +
  theme_minimal() +
  labs(x = "Gestational Age (Weeks)",
       y = "Average Length of Stay (Days)",
       title = "Average Length of Stay by Gestational Age")
```

```{r duke_nicu_clean-hist4}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = birth_weight)) +
  geom_histogram(bins = 30, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Birth Weight (Grams)",
       y = "Number of Infants",
       title = "Distribution of Birth Weight")
```

```{r duke_nicu_clean-scatter, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = birth_weight,
                     y = length_of_stay)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(x = "Birth Weight (Grams)",
       y = "Length of Stay (Days)",
       title = "Length of Stay vs. Birth Weight",)
```

```{r duke_nicu_clean-bar2}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = gender,
                     fill = gender)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_manual(values = c("Female" = "#B07AA1",
                               "Male" = "#4E79A7")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Number of Infants",
       title = "Distribution of Gender")
```

```{r duke_nicu_clean-boxplot, warning = FALSE}
ggplot(data = duke_nicu_clean %>% filter(ivh != "Missing"),
       mapping = aes(x = length_of_stay,
                     y = fct_relevel(ivh, "None", "Grade I", "Grade II",
                                     "Grade III", "Grade IV"))) +
  geom_boxplot(fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by IVH Grade")
```

```{r duke_nicu_clean-bar3}
ggplot(data = duke_nicu_clean %>% filter(ivh != "Missing"),
       mapping = aes(x = fct_relevel(ivh, "None", "Grade I", "Grade II",
                                     "Grade III", "Grade IV"),
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by IVH Grade",
       fill = "Survival Status")
```

```{r duke_nicu_clean-boxplot2, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = length_of_stay,
                     y = rop)) +
  geom_boxplot(fill = "#4E79A7") +
  scale_y_discrete(labels = c("Stage III–IV (No Cryo or Laser Surgery)" = "Stage III–IV (No Tx)",
                              "Stage III–IV (With Cryo or Laser Surgery)" = "Stage III–IV (Tx)")) +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by ROP Stage")
```

```{r duke_nicu_clean-bar4}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = rop,
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_x_discrete(labels = c("Stage III–IV (No Cryo or Laser Surgery)" = "Stage III–IV
(No Tx)",
                              "Stage III–IV (With Cryo or Laser Surgery)" = "Stage III–IV
(Tx)")) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by ROP Stage",
       fill = "Survival Status")
```

```{r duke_nicu_clean-boxplot3, warning = FALSE}
ggplot(data = duke_nicu_clean %>% filter(nec != "Missing"),
       mapping = aes(x = length_of_stay,
                     y = fct_relevel(nec, "None", "Surgical", "Medical"))) +
  geom_boxplot(fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by NEC Type")
```

```{r duke_nicu_clean-bar5}
ggplot(data = duke_nicu_clean %>% filter(nec != "Missing"),
       mapping = aes(x = fct_relevel(nec, "None", "Surgical", "Medical"),
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by NEC Type",
       fill = "Survival Status")
```

```{r duke_nicu_clean-boxplot4, warning = FALSE}
ggplot(data = duke_nicu_clean %>% filter(pda != "Missing"),
       mapping = aes(x = length_of_stay,
                     y = pda)) +
  geom_boxplot(fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by PDA Management")
```

```{r duke_nicu_clean-bar6}
ggplot(data = duke_nicu_clean %>% filter(pda != "Missing"),
       mapping = aes(x = pda,
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_x_discrete(labels = c("None (Medication Only)" = "None
(Medication Only)",
                              "Yes (Ligated)" = "Yes
(Ligated)",
                              "Yes (Medically Treated)" = "Yes
(Medically Treated)",
                              "Yes (Untreated)" = "Yes
(Untreated)")) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by PDA Management",
       fill = "Survival Status")
```

```{r duke_nicu_clean-ggpairs, message = FALSE, warning = FALSE}
duke_nicu_clean %>%
  select(gestational_age, birth_weight, length_of_stay) %>%
  ggpairs()
```


## Modeling

```{r duke_nicu_model}
duke_nicu_model <- duke_nicu_clean %>%
  filter(!is.na(length_of_stay))

glimpse(duke_nicu_model)
```

```{r duke_nicu_model_split}
set.seed(1234)
duke_nicu_model_split <- initial_split(duke_nicu_model, prop = 0.80)

train_data <- training(duke_nicu_model_split)
test_data <- testing(duke_nicu_model_split)

glimpse(train_data)
glimpse(test_data)
```


### Linear Regression Models

```{r full_lm}
full_lm <- lm(length_of_stay ~ . - patient_id, data = train_data)

summary(full_lm)
```

```{r train_data2, test_data2}
train_data2 <- train_data %>%
  mutate(log_los = log(length_of_stay + 1))

test_data2 <- test_data %>%
  mutate(log_los = log(length_of_stay + 1))
```

```{r full_lm_log}
full_lm_log <- lm(log_los ~ . - patient_id - length_of_stay, data = train_data2)

summary(full_lm_log)
```

```{r ctrl}
set.seed(1234)
ctrl <- trainControl(method = "cv", number = 10)
```

```{r lm_caret}
lm_caret <- train(length_of_stay ~ . - patient_id,
                  data = train_data,
                  method = "lm",
                  trControl = ctrl,
                  metric = "RMSE")

lm_caret
```

```{r lm_log_caret}
lm_log_caret <- train(log_los ~ . - patient_id - length_of_stay,
                      data = train_data2,
                      method = "lm",
                      trControl = ctrl,
                      metric = "RMSE")

lm_log_caret
```

```{r full_aug-scatter}
full_aug <- augment(full_lm)

ggplot(data = full_aug,
       mapping = aes(x = .fitted,
                     y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = 2) +
  theme_minimal() +
  labs(x = "Fitted Values",
       y = "Residuals",
       title = "Residuals vs. Fitted Values for Length of Stay Model")
```

```{r log_aug-scatter}
log_aug <- augment(full_lm_log)

ggplot(data = log_aug,
       mapping = aes(x = .fitted,
                     y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = 2) +
  theme_minimal() +
  labs(x = "Fitted Values",
       y = "Residuals",
       title = "Residuals vs. Fitted Values for Log Length of Stay Model")
```

```{r log_aug-qq}
ggplot(data = log_aug,
       mapping = aes(sample = .resid)) +
  stat_qq(alpha = 0.5) +
  stat_qq_line(color = "blue") +
  theme_minimal() +
  labs(x = "Theoretical Quantiles",
       y = "Sample Quantiles",
       title = "Normal Q–Q Plot of Residuals for Log Length of Stay Model")
```


### Decision Tree Model

```{r tree_model}
tree_model <- rpart(log_los ~ . - patient_id - length_of_stay,
                    data = train_data2,
                    method = "anova")

summary(tree_model)
```

```{r tree_model-plot}
rpart.plot(tree_model, type = 3, extra = 101)
```


### Random Forest Model

```{r rf_model}
rf_model <- ranger(log_los ~ . - patient_id - length_of_stay,
                   data = train_data2,
                   num.trees = 500,
                   importance = "impurity")
```

```{r rf_model-variable.importance}
rf_model$variable.importance
```

```{r importance_df}
importance_df <- data.frame(variable = names(rf_model$variable.importance),
                            importance = rf_model$variable.importance)

ggplot(data = importance_df,
       mapping = aes(x = importance,
                     y = reorder(variable, importance))) +
  geom_col(fill = "#4E79A7") +
  scale_y_discrete(labels = c("birth_weight" = "Birth Weight",
                              "gestational_age" = "Gestational Age",
                              "rop" = "ROP",
                              "pda" = "PDA",
                              "survival_status" = "Survival Status",
                              "inborn" = "Inborn",
                              "ivh" = "IVH",
                              "race_ethnicity" = "Race/Ethnicity",
                              "nec" = "NEC",
                              "gender" = "Gender")) +
  theme_minimal() +
  labs(x = "Variable Importance",
       y = NULL,
       title = "Random Forest Variable Importance for Log Length of Stay")
```


### Predictive Performance

```{r lm_pred, tree_pred, rf_pred}
lm_pred <- predict(full_lm_log, newdata = test_data2)

tree_pred <- predict(tree_model, newdata = test_data2)

rf_pred <- predict(rf_model, data = test_data2)$predictions
```

```{r rmse_lm, rmse_tree, rmse_rf}
rmse <- function(actual, predicted) {sqrt(mean((actual - predicted)^2))}

rmse_lm  <- rmse(test_data2$log_los, lm_pred)
rmse_tree <- rmse(test_data2$log_los, tree_pred)
rmse_rf <- rmse(test_data2$log_los, rf_pred)

rmse_lm
rmse_tree
rmse_rf
```