---
title: "Honors Thesis - NICU Data Analysis"
author: "Emilee Lewis"
date: "2/9/2026"
output:
  html_document:
    highlight: tango
    theme: flatly
---


```{r knitr, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r load-packages, warning = FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(GGally)
library(tidymodels)
library(caret)
library(broom)
library(rpart)
library(rpart.plot)
library(ranger)
```


```{r load-data}
duke_nicu <- read_xlsx("Data/Duke NICU Data.xlsx")
```


## Data Dictionary

| Variable                      | Description
|:----------------|:-----------------------------------------------------------------
|`patient_id`                   | De-identified, randomized patient identification number assigned to each infant
|`survival_status`              | Whether the infant was alive or deceased at the time of discharge
|`gestational_age`              | Gestational age at birth (in weeks)
|`birth_weight`                 | Birth weight of the infant (in grams)
|`gender`                       | Sex of the infant
|`inborn`                       | Whether the infant was born at Duke Hospital or transferred from another facility (`Yes`, `No`)
|`race_ethnicity`               | Racial/ethnic classification of the infant (`White`, `Black`, `Other`)
|`length_of_stay`               | Total length of stay (in days) from admission to discharge or death
|`ivh`                          | Presence or grade of intraventricular hemorrhage (IVH), bleeding into the internal structures of the brain (`None`, `Grade I`, `Grade II`, `Grade III`, `Grade IV`)
|`rop`                          | Presence or stage of retinopathy of prematurity (ROP), a condition affecting blood vessels in the eye that leads to blindness if not promptly treated (`None`, `Stage I`, `Stage II`, `Stage III–IV (No Cryo or Laser Surgery)`, `Stage III–IV (With Cryo or Laser Surgery)`)
|`nec`                          | Presence or type of necrotizing enterocolitis (NEC), a severe neonatal intestinal condition (`None`, `Medical`, `Surgical`)
|`pda`                          | Presence and management of patent ductus arteriosus (PDA), a neonatal cardiovascular anomaly requiring medical or surgical intervention (`None`, `None (Medication Only)`, `Yes (Medically Treated)`, `Yes (Ligated)`, `Yes (Untreated)`)


## Data Cleaning

```{r duke_nicu_clean}
duke_nicu_clean <- duke_nicu %>%
  select(-"BWgt", -"ROP", -"PDA", -"LOS Predictor") %>%
  clean_names() %>%
  rename(patient_id = pt_id_rnd_num,
         survival_status = alive_died,
         gestational_age = gest_age,
         length_of_stay = los,
         rop = rop_abbrev,
         pda = pda_condensed_rx) %>%
  mutate(gender = recode(gender,
                         "M" = "Male",
                         "F" = "Female"),
         inborn = recode(inborn,
                         "YES" = "Yes",
                         "NO" = "No"),
         race_ethnicity = recode(race_ethnicity,
                                 "OTHER" = "Other",
                                 "WHITE" = "White",
                                 "BLACK" = "Black"),
         ivh = recode(ivh,
                      "NONE" = "None",
                      "GRADE I" = "Grade I",
                      "GRADE II" = "Grade II",
                      "GRADE III" = "Grade III",
                      "GRADE IV" = "Grade IV"),
         rop = recode(rop,
                      "NONE" = "None",
                      "STAGE I" = "Stage I",
                      "STAGE II" = "Stage II",
                      "STAGE III-IV WITH CRYO OR LASER SURGERY" = "Stage III–IV (With Cryo or Laser Surgery)",
                      "STAGE III-IV, NO CRYO OR LASER SURGERY" = "Stage III–IV (No Cryo or Laser Surgery)"),
         nec = recode(nec,
                      "NONE" = "None",
                      "MEDICAL" = "Medical",
                      "SURGICAL" = "Surgical"),
         pda = recode(pda,
                      "NONE" = "None",
                      "NONE-RX" = "None (Medication Only)",
                      "YES, LIGATED" = "Yes (Ligated)",
                      "YES-RX" = "Yes (Medically Treated)",
                      "YES, NO TX" = "Yes (Untreated)"),
         ivh = fct_explicit_na(ivh, na_level = "Missing"),
         nec = fct_explicit_na(nec, na_level = "Missing"),
         pda = fct_explicit_na(pda, na_level = "Missing"),
         across(c(gender, inborn, race_ethnicity, survival_status,
                  ivh, rop, nec, pda), ~ as.factor(.)))
```

```{r duke_nicu_clean-colSums}
colSums(is.na(duke_nicu_clean))
```

```{r duke_nicu_clean-summary}
summary(duke_nicu_clean$gestational_age)
summary(duke_nicu_clean$birth_weight)
summary(duke_nicu_clean$length_of_stay)
```

```{r duke_nicu_clean_2}
duke_nicu_clean_2 <- duke_nicu_clean %>%
  mutate(ivh_2 = case_when(ivh %in% c("None", "Missing") ~ "No",
                           TRUE ~ "Yes"),
         rop_2 = case_when(rop %in% c("None", "Missing") ~ "No",
                           TRUE ~ "Yes"),
         nec_2 = case_when(nec %in% c("None", "Missing") ~ "No",
                           TRUE ~ "Yes"),
         pda_2 = case_when(pda %in% c("None",
                                      "None (Medication Only)",
                                      "Missing") ~ "No",
                           TRUE ~ "Yes")) %>%
  mutate(across(ends_with("_2"), ~ factor(.x, levels = c("No", "Yes"))))
```

```{r duke_nicu_clean_3}
duke_nicu_clean_3 <- duke_nicu_clean_2 %>%
  mutate(los_category = case_when(length_of_stay <= 5  ~ "0-5",
                                  length_of_stay <= 10 ~ "6-10",
                                  length_of_stay <= 20 ~ "11-20",
                                  length_of_stay <= 30 ~ "21-30",
                                  length_of_stay > 30  ~ "31+")) %>%
  mutate(los_category = factor(los_category, levels = c("0-5",
                                                        "6-10",
                                                        "11-20",
                                                        "21-30",
                                                        "31+")))
```

```{r duke_nicu_clean_4}
duke_nicu_clean_4 <- duke_nicu_clean_2 %>%
  mutate(los_category_2 = case_when(length_of_stay <= 5  ~ "0-5",
                                    length_of_stay <= 20 ~ "6-20",
                                    length_of_stay > 20  ~ "21+")) %>%
  mutate(los_category_2 = factor(los_category_2, levels = c("0-5",
                                                            "6-20",
                                                            "21+")))
```


## Exploratory Data Analysis

```{r duke_nicu_clean-hist, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = length_of_stay)) +
  geom_histogram(bins = 30, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = "Number of Infants",
       title = "Distribution of Length of Stay")
```

```{r duke_nicu_clean-boxplot, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = length_of_stay)) +
  geom_boxplot(color = "black", fill = "#4E79A7") +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Distribution of Length of Stay")
```

```{r duke_nicu_clean-length_of_stay-median}
median(duke_nicu_clean$length_of_stay, na.rm = TRUE)
```

```{r duke_nicu_clean-hist2, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = log(length_of_stay + 1))) +
  geom_histogram(bins = 20, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "log(LOS + 1)",
       y = "Number of Infants",
       title = "Log-Transformed Distribution of Length of Stay")
```

```{r duke_nicu_clean-boxplot2, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = log(length_of_stay + 1))) +
  geom_boxplot(color = "black", fill = "#4E79A7") +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  labs(x = "log(LOS + 1)",
       y = NULL,
       title = "Log-Transformed Distribution of Length of Stay")
```

```{r duke_nicu_clean-bar}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = survival_status,
                     fill = survival_status)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Number of Infants",
       title = "Distribution of Survival Status")
```

```{r duke_nicu_clean-col}
duke_nicu_clean %>%
  group_by(survival_status) %>%
  summarize(mean_los = mean(length_of_stay, na.rm = TRUE)) %>%
  ggplot(mapping = aes(x = survival_status,
                       y = mean_los,
                       fill = survival_status)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Average Length of Stay (Days)",
       title = "Average Length of Stay by Survival Status")
```

```{r duke_nicu_clean-hist3}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = gestational_age)) +
  geom_histogram(bins = 20, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Gestational Age (Weeks)",
       y = "Number of Infants",
       title = "Distribution of Gestational Age")
```

```{r duke_nicu_clean-line}
duke_nicu_clean %>%
  group_by(gestational_age) %>%
  summarize(mean_los = mean(length_of_stay, na.rm = TRUE)) %>%
  ggplot(mapping = aes(x = gestational_age,
                       y = mean_los)) +
  geom_line(color = "#4E79A7") +
  geom_point() +
  theme_minimal() +
  labs(x = "Gestational Age (Weeks)",
       y = "Average Length of Stay (Days)",
       title = "Average Length of Stay by Gestational Age")
```

```{r duke_nicu_clean-hist4}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = birth_weight)) +
  geom_histogram(bins = 30, color = "black", fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Birth Weight (Grams)",
       y = "Number of Infants",
       title = "Distribution of Birth Weight")
```

```{r duke_nicu_clean-scatter, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = birth_weight,
                     y = length_of_stay)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(x = "Birth Weight (Grams)",
       y = "Length of Stay (Days)",
       title = "Length of Stay vs. Birth Weight")
```

```{r duke_nicu_clean-bar2}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = gender,
                     fill = gender)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_manual(values = c("Female" = "#B07AA1",
                               "Male" = "#4E79A7")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Number of Infants",
       title = "Distribution of Gender")
```

```{r duke_nicu_clean-boxplot3, warning = FALSE}
ggplot(data = duke_nicu_clean %>% filter(ivh != "Missing"),
       mapping = aes(x = length_of_stay,
                     y = fct_relevel(ivh, "None", "Grade I", "Grade II",
                                     "Grade III", "Grade IV"))) +
  geom_boxplot(fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by IVH Grade")
```

```{r duke_nicu_clean-bar3}
ggplot(data = duke_nicu_clean %>% filter(ivh != "Missing"),
       mapping = aes(x = fct_relevel(ivh, "None", "Grade I", "Grade II",
                                     "Grade III", "Grade IV"),
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by IVH Grade",
       fill = "Survival Status")
```

```{r duke_nicu_clean-ivh-summary-stats}
duke_nicu_clean %>%
  group_by(ivh) %>%
  summarise(n = n(),
            mean_los = mean(length_of_stay, na.rm = TRUE),
            median_los = median(length_of_stay, na.rm = TRUE),
            IQR_los = IQR(length_of_stay, na.rm = TRUE),
            min_los = min(length_of_stay, na.rm = TRUE),
            max_los = max(length_of_stay, na.rm = TRUE))
```

```{r duke_nicu_clean-boxplot4, warning = FALSE}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = length_of_stay,
                     y = rop)) +
  geom_boxplot(fill = "#4E79A7") +
  scale_y_discrete(labels = c("Stage III–IV (No Cryo or Laser Surgery)" = "Stage III–IV (No Tx)",
                              "Stage III–IV (With Cryo or Laser Surgery)" = "Stage III–IV (Tx)")) +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by ROP Stage")
```

```{r duke_nicu_clean-bar4}
ggplot(data = duke_nicu_clean,
       mapping = aes(x = rop,
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_x_discrete(labels = c("Stage III–IV (No Cryo or Laser Surgery)" = "Stage III–IV
(No Tx)",
                              "Stage III–IV (With Cryo or Laser Surgery)" = "Stage III–IV
(Tx)")) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by ROP Stage",
       fill = "Survival Status")
```

```{r duke_nicu_clean-rop-summary-stats}
duke_nicu_clean %>%
  group_by(rop) %>%
  summarise(n = n(),
            mean_los = mean(length_of_stay, na.rm = TRUE),
            median_los = median(length_of_stay, na.rm = TRUE),
            IQR_los = IQR(length_of_stay, na.rm = TRUE),
            min_los = min(length_of_stay, na.rm = TRUE),
            max_los = max(length_of_stay, na.rm = TRUE))
```

```{r duke_nicu_clean-boxplot5, warning = FALSE}
ggplot(data = duke_nicu_clean %>% filter(nec != "Missing"),
       mapping = aes(x = length_of_stay,
                     y = fct_relevel(nec, "None", "Surgical", "Medical"))) +
  geom_boxplot(fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by NEC Type")
```

```{r duke_nicu_clean-bar5}
ggplot(data = duke_nicu_clean %>% filter(nec != "Missing"),
       mapping = aes(x = fct_relevel(nec, "None", "Surgical", "Medical"),
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by NEC Type",
       fill = "Survival Status")
```

```{r duke_nicu_clean-nec-summary-stats}
duke_nicu_clean %>%
  group_by(nec) %>%
  summarise(n = n(),
            mean_los = mean(length_of_stay, na.rm = TRUE),
            median_los = median(length_of_stay, na.rm = TRUE),
            IQR_los = IQR(length_of_stay, na.rm = TRUE),
            min_los = min(length_of_stay, na.rm = TRUE),
            max_los = max(length_of_stay, na.rm = TRUE))
```

```{r duke_nicu_clean-boxplot6, warning = FALSE}
ggplot(data = duke_nicu_clean %>% filter(pda != "Missing"),
       mapping = aes(x = length_of_stay,
                     y = pda)) +
  geom_boxplot(fill = "#4E79A7") +
  theme_minimal() +
  labs(x = "Length of Stay (Days)",
       y = NULL,
       title = "Length of Stay by PDA Management")
```

```{r duke_nicu_clean-bar6}
ggplot(data = duke_nicu_clean %>% filter(pda != "Missing"),
       mapping = aes(x = pda,
                     fill = survival_status)) +
  geom_bar(position = "fill") +
  scale_x_discrete(labels = c("None (Medication Only)" = "None
(Medication Only)",
                              "Yes (Ligated)" = "Yes
(Ligated)",
                              "Yes (Medically Treated)" = "Yes
(Medically Treated)",
                              "Yes (Untreated)" = "Yes
(Untreated)")) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Alive" = "#4E79A7",
                               "Died" = "#E15759")) +
  theme_minimal() +
  labs(x = NULL,
       y = "Proportion",
       title = "Survival Outcomes by PDA Management",
       fill = "Survival Status")
```

```{r duke_nicu_clean-pda-summary-stats}
duke_nicu_clean %>%
  group_by(pda) %>%
  summarise(n = n(),
            mean_los = mean(length_of_stay, na.rm = TRUE),
            median_los = median(length_of_stay, na.rm = TRUE),
            IQR_los = IQR(length_of_stay, na.rm = TRUE),
            min_los = min(length_of_stay, na.rm = TRUE),
            max_los = max(length_of_stay, na.rm = TRUE))
```

```{r duke_nicu_clean-ggpairs, message = FALSE, warning = FALSE}
duke_nicu_clean %>%
  select(gestational_age, birth_weight, length_of_stay) %>%
  ggpairs()
```


## Modeling

```{r duke_nicu_model}
duke_nicu_model <- duke_nicu_clean_2 %>%
  filter(!is.na(length_of_stay))

glimpse(duke_nicu_model)
```

```{r duke_nicu_model_split}
set.seed(1234)

duke_nicu_model_split <- initial_split(duke_nicu_model, prop = 0.80)

train_data <- training(duke_nicu_model_split)
test_data <- testing(duke_nicu_model_split)

glimpse(train_data)
glimpse(test_data)
```


### Linear Regression Models

```{r full_lm}
full_lm <- lm(length_of_stay ~ . - patient_id
              - ivh_2 - rop_2 - nec_2 - pda_2,
              data = train_data)

summary(full_lm)
```

```{r train_data_2, test_data_2}
train_data_2 <- train_data %>%
  mutate(log_los = log(length_of_stay + 1))

test_data_2 <- test_data %>%
  mutate(log_los = log(length_of_stay + 1))
```

```{r full_lm_log}
full_lm_log <- lm(log_los ~ . - patient_id - length_of_stay
                  - ivh_2 - rop_2 - nec_2 - pda_2,
                  data = train_data_2)

summary(full_lm_log)
```

```{r full_lm_log_categorical}
full_lm_log_categorical <- lm(log_los ~ . - patient_id - length_of_stay 
                              - ivh - rop - nec - pda,
                              data = train_data_2)

summary(full_lm_log_categorical)
```

```{r ctrl}
set.seed(1234)
ctrl <- trainControl(method = "cv", number = 10)
```

```{r lm_caret}
lm_caret <- train(length_of_stay ~ . - patient_id
                  - ivh_2 - rop_2 - nec_2 - pda_2,
                  data = train_data,
                  method = "lm",
                  trControl = ctrl,
                  metric = "RMSE")

lm_caret
```

```{r lm_log_caret}
lm_log_caret <- train(log_los ~ . - patient_id - length_of_stay
                      - ivh_2 - rop_2 - nec_2 - pda_2,
                      data = train_data_2,
                      method = "lm",
                      trControl = ctrl,
                      metric = "RMSE")

lm_log_caret
```

```{r lm_log_categorical_caret}
lm_log_categorical_caret <- train(log_los ~ . - patient_id - length_of_stay
                      - ivh - rop - nec - pda,
                      data = train_data_2,
                      method = "lm",
                      trControl = ctrl,
                      metric = "RMSE")

lm_log_categorical_caret
```

```{r full_aug-scatter}
full_aug <- augment(full_lm)

ggplot(data = full_aug,
       mapping = aes(x = .fitted,
                     y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = 2) +
  theme_minimal() +
  labs(x = "Fitted Values",
       y = "Residuals",
       title = "Residuals vs. Fitted Values for Length of Stay Model")
```

```{r log_aug-scatter}
log_aug <- augment(full_lm_log)

ggplot(data = log_aug,
       mapping = aes(x = .fitted,
                     y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = 2) +
  theme_minimal() +
  labs(x = "Fitted Values",
       y = "Residuals",
       title = "Residuals vs. Fitted Values for Log Length of Stay Model")
```

```{r log_aug-qq}
ggplot(data = log_aug,
       mapping = aes(sample = .resid)) +
  stat_qq(alpha = 0.5) +
  stat_qq_line(color = "blue") +
  theme_minimal() +
  labs(x = "Theoretical Quantiles",
       y = "Sample Quantiles",
       title = "Normal Q–Q Plot of Residuals for Log Length of Stay Model")
```


### Decision Tree Model

```{r tree_model}
tree_model <- rpart(log_los ~ . - patient_id - length_of_stay
                    - ivh_2 - nec_2 - rop_2 - pda_2,
                    data = train_data_2,
                    method = "anova")

summary(tree_model)
```

```{r tree_model-plot}
rpart.plot(tree_model, type = 3, extra = 101)
```


### Random Forest Models

```{r rf_model}
rf_model <- ranger(length_of_stay ~ . - patient_id
                   - ivh_2 - nec_2 - rop_2 - pda_2,
                   data = train_data,
                   num.trees = 500,
                   importance = "impurity")

rf_model
sqrt(rf_model$prediction.error)
```

```{r rf_log_model}
rf_log_model <- ranger(log_los ~ . - patient_id - length_of_stay
                       - ivh_2 - nec_2 - rop_2 - pda_2,
                   data = train_data_2,
                   num.trees = 500,
                   importance = "impurity")

rf_log_model
sqrt(rf_log_model$prediction.error)
```

```{r rf_categorical_model}
rf_categorical_model <- ranger(length_of_stay ~ . - patient_id
                               - ivh - nec - rop - pda,
                               data = train_data,
                               num.trees = 500,
                               importance = "impurity")

rf_categorical_model
sqrt(rf_categorical_model$prediction.error)
```

```{r rf_categorical_log_model}
rf_categorical_log_model <- ranger(log_los ~ . - patient_id - length_of_stay
                                   - ivh - nec - rop - pda,
                                   data = train_data_2,
                                   num.trees = 500,
                                   importance = "impurity")

rf_categorical_log_model
sqrt(rf_categorical_log_model$prediction.error)
```

```{r rf_compare}
tibble(model = c("RF LOS (Severity)",
                 "RF log LOS (Severity)",
                 "RF LOS (Categorical)",
                 "RF log LOS (Categorical)"),
       oob_rmse = c(sqrt(rf_model$prediction.error),
                    sqrt(rf_log_model$prediction.error),
                    sqrt(rf_categorical_model$prediction.error),
                    sqrt(rf_categorical_log_model$prediction.error)))
```

```{r rf_formula, p}
rf_formula <- length_of_stay ~ . - patient_id - ivh_2 - nec_2 - rop_2 - pda_2

p <- ncol(model.matrix(rf_formula, data = train_data)) - 1
p
```

```{r mtry_grid}
mtry_grid <- c(4, 5, 6, 7, 8, 9, 10)
```

```{r rf_mtry_results}
set.seed(1234)

rf_mtry_results <- purrr::map_dfr(mtry_grid, function(m)
  {rf_fit <- ranger(formula = rf_formula,
                    data = train_data,
                    num.trees = 500,
                    mtry = m,
                    importance = "impurity")
  tibble(mtry = m,
         oob_rmse = sqrt(rf_fit$prediction.error))})

rf_mtry_results
```

```{r mtry_grid_2, tree_grid}
mtry_grid_2 <- c(4, 5, 6)
tree_grid <- c(300, 500, 800)
```

```{r rf_grid}
rf_grid <- expand.grid(mtry = mtry_grid_2,
                       num_trees = tree_grid)

rf_grid
```

```{r rf_grid_results}
set.seed(1234)

rf_grid_results <- purrr::pmap_dfr(rf_grid, function(mtry, num_trees)
  {rf_fit <- ranger(formula = rf_formula,
                    data = train_data,
                    num.trees = num_trees,
                    mtry = mtry,
                    importance = "impurity")
  tibble(mtry = mtry,
         num_trees = num_trees,
         oob_rmse = sqrt(rf_fit$prediction.error))})

rf_grid_results
```

```{r rf_model_final}
set.seed(1234)

rf_model_final <- ranger(formula = rf_formula,
                         data = train_data,
                         num.trees = 500,
                         mtry = 4,
                         importance = "impurity")

rf_model_final
```

```{r importance_df}
importance_df <- data.frame(variable = names(rf_model_final$variable.importance),
                            importance = rf_model_final$variable.importance)

ggplot(data = importance_df,
       mapping = aes(x = importance,
                     y = reorder(variable, importance))) +
  geom_col(fill = "#4E79A7") +
  scale_y_discrete(labels = c("rop" = "ROP",
                              "birth_weight" = "Birth Weight",
                              "gestational_age" = "Gestational Age",
                              "pda" = "PDA",
                              "ivh" = "IVH",
                              "survival_status" = "Survival Status",
                              "race_ethnicity" = "Race/Ethnicity",
                              "inborn" = "Inborn",
                              "gender" = "Gender",
                              "nec" = "NEC")) +
  theme_minimal() +
  labs(x = "Variable Importance",
       y = NULL,
       title = "Random Forest Variable Importance for Length of Stay")
```


### Random Forest with Restriction to the 90th Percentile Model

```{r los_90}
los_90 <- quantile(train_data$length_of_stay, 0.90)

los_90
```

```{r train_data_90, test_data_90}
train_data_90 <- train_data %>%
  filter(length_of_stay <= los_90)

test_data_90 <- test_data %>%
  filter(length_of_stay <= los_90)
```

```{r rf_model_final_90}
set.seed(1234)

rf_model_final_90 <- ranger(formula = rf_formula,
                            data = train_data_90,
                            num.trees = 500,
                            mtry = 4,
                            importance = "impurity")

rf_model_final_90
```


### Random Forest Classification Model (5 Categories)

```{r duke_nicu_clean_3-table}
table(duke_nicu_clean_3$los_category)
```

```{r duke_nicu_model_class}
duke_nicu_model_class <- duke_nicu_clean_3 %>%
  filter(!is.na(los_category))

glimpse(duke_nicu_model_class)
```

```{r duke_nicu_model_class_split}
set.seed(1234)

duke_nicu_model_class_split <- initial_split(duke_nicu_model_class,
                             prop = 0.80,
                             strata = los_category)

train_data_3 <- training(duke_nicu_model_class_split)
test_data_3  <- testing(duke_nicu_model_class_split)

glimpse(train_data_3)
glimpse(test_data_3)
```

```{r mtry_grid_3, tree_grid_2}
mtry_grid_3 <- c(3, 4, 5, 6, 7, 8)
tree_grid_2 <- c(300, 500, 800)
```

```{r rf_grid_2}
rf_grid_2 <- expand.grid(mtry_2 = mtry_grid_3,
                         num_trees_2 = tree_grid_2)

rf_grid_2
```

```{r rf_grid_results_2}
set.seed(1234)

rf_grid_results_2 <- purrr::pmap_dfr(rf_grid_2, function(mtry_2, num_trees_2)
  {rf_fit_2 <- ranger(formula = los_category ~ .
                      - patient_id - length_of_stay,
                      data = train_data_3,
                      num.trees = num_trees_2,
                      mtry = mtry_2,
                      importance = "impurity",
                      probability = TRUE)
  tibble(mtry_2 = mtry_2,
         num_trees_2 = num_trees_2,
         oob_error = rf_fit_2$prediction.error,
         oob_accuracy = 1 - rf_fit_2$prediction.error)})

rf_grid_results_2
```

```{r best_rf_class}
best_rf_class <- rf_grid_results_2 %>%
  arrange(oob_error) %>%
  slice(1)

best_rf_class
```

```{r rf_class_model}
set.seed(1234)

rf_class_model <- ranger(formula = los_category ~ .
                         - patient_id - length_of_stay,
                         data = train_data_3,
                         num.trees = best_rf_class$num_trees_2,
                         mtry = best_rf_class$mtry_2,
                         importance = "impurity",
                         probability = TRUE)
```

```{r rf_class_pred, predicted_classes}
rf_class_preds <- predict(rf_class_model, data = test_data_3)

predicted_classes <- colnames(rf_class_preds$predictions)[
                              max.col(rf_class_preds$predictions)]

predicted_classes <- factor(predicted_classes,
                            levels = levels(test_data_3$los_category))
```

```{r confusion-matrix}
confusionMatrix(predicted_classes, test_data_3$los_category)
```


### Random Forest Classification Model (3 Categories)

```{r duke_nicu_clean_4-table}
table(duke_nicu_clean_4$los_category_2)
```

```{r duke_nicu_model_class_2}
duke_nicu_model_class_2 <- duke_nicu_clean_4 %>%
  filter(!is.na(los_category_2))

glimpse(duke_nicu_model_class_2)
```

```{r duke_nicu_model_class_split_2}
set.seed(1234)

duke_nicu_model_class_split_2 <- initial_split(duke_nicu_model_class_2,
                                               prop = 0.80,
                                               strata = los_category_2)

train_data_4 <- training(duke_nicu_model_class_split_2)
test_data_4  <- testing(duke_nicu_model_class_split_2)

glimpse(train_data_4)
glimpse(test_data_4)
```

```{r mtry_grid_4, tree_grid_3}
mtry_grid_4 <- c(3, 4, 5, 6, 7, 8)
tree_grid_3 <- c(300, 500, 800)
```

```{r rf_grid_3}
rf_grid_3 <- expand.grid(mtry_3 = mtry_grid_4,
                         num_trees_3 = tree_grid_3)

rf_grid_3
```

```{r rf_grid_results_3}
set.seed(1234)

rf_grid_results_3 <- purrr::pmap_dfr(rf_grid_3, function(mtry_3, num_trees_3)
  {rf_fit_3 <- ranger(formula = los_category_2 ~ .
                      - patient_id - length_of_stay,
                      data = train_data_4,
                      num.trees = num_trees_3,
                      mtry = mtry_3,
                      importance = "impurity",
                      probability = TRUE)
  tibble(mtry_3 = mtry_3,
         num_trees_3 = num_trees_3,
         oob_error = rf_fit_3$prediction.error,
         oob_accuracy = 1 - rf_fit_3$prediction.error)})

rf_grid_results_3
```

```{r best_rf_class_2}
best_rf_class_2 <- rf_grid_results_3 %>%
  arrange(oob_error) %>%
  slice(1)

best_rf_class_2
```

```{r rf_class_model_2}
set.seed(1234)

rf_class_model_2 <- ranger(formula = los_category_2 ~ .
                           - patient_id - length_of_stay,
                           data = train_data_4,
                           num.trees = best_rf_class_2$num_trees_3,
                           mtry = best_rf_class_2$mtry_3,
                           importance = "impurity",
                           probability = TRUE)
```

```{r rf_class_pred_2, predicted_classes_2}
rf_class_preds_2 <- predict(rf_class_model_2, data = test_data_4)

predicted_classes_2 <- colnames(rf_class_preds_2$predictions)[
                                max.col(rf_class_preds_2$predictions)]

predicted_classes_2 <- factor(predicted_classes_2,
                              levels = levels(test_data_4$los_category_2))
```

```{r confusion-matrix2}
confusionMatrix(predicted_classes_2, test_data_4$los_category_2)
```


## Predictive Performance

```{r rmse}
rmse <- function(actual, predicted)
  {sqrt(mean((actual - predicted)^2))}
```

```{r lm_log_preds, rf_preds, rf_preds_90}
lm_log_preds <- predict(full_lm_log, newdata = test_data_2)
lm_log_preds_days <- exp(lm_log_preds) - 1

rf_preds <- predict(rf_model_final, data = test_data)$predictions

rf_preds_90 <- predict(rf_model_final_90, data = test_data_90)$predictions
```

```{r rmse_comparison}
rmse_comparison <- tibble(Model = c("Log-Linear Regression",
                                    "Random Forest",
                                    "Random Forest (90th Percentile)"),
                          RMSE = c(rmse(test_data$length_of_stay, lm_log_preds_days),
                                   rmse(test_data$length_of_stay, rf_preds),
                                   rmse(test_data_90$length_of_stay, rf_preds_90)))

rmse_comparison
```

```{r doctor_rmse}
test_ids <- test_data$patient_id

doctor_test_data <- duke_nicu %>%
  rename(patient_id = `Pt ID (Rnd num)`) %>%
  filter(patient_id %in% test_ids)

doctor_rmse <- rmse(doctor_test_data$LOS,
                    doctor_test_data$`LOS Predictor`)

doctor_rmse
```